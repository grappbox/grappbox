<!--
    Summary: Ticket view
-->

<ion-view>
    <ion-nav-title>Ticket</ion-nav-title>
    <ion-content overflow-scroll="false">

        <!-- Refresher -->
        <ion-refresher pulling-text="Pull to refresh..."
                       on-refresh="doRefresh()">
        </ion-refresher>

        <div class="item item-divider item-icon-right">Ticket<i ng-show="ticket.creator.id == userConnectedId" class="icon ion-edit gb-color-bugtracker" ui-sref="app.editTicket({projectId: projectId, ticketId: ticketId})"></i></div>

        <div class="item">
            <!-- Ticket's title -->
            <h2>{{ticket.title}}</h2>

            <!-- Tags on ticket -->
            <i ng-if="ticket.tags[0]" class="icon ion-ios-pricetag larger gb-color-bugtracker"></i>&nbsp<button ng-if="ticket.tags[0]" ng-repeat="tag in ticket.tags" class="button button-small button-balanced gb-button-tag">{{ tag.name }}</button><br />

            <!-- Users on ticket -->
            <i ng-if="ticket.users[0]" class="icon ion-ios-person larger gb-color-bugtracker"></i>&nbsp<button ng-if="ticket.users[0]" ng-repeat="user in ticket.users" class="button button-small button-calm gb-button-tag">{{ user.firstname }} {{ user.lastname }}</button><!--<br ng-if="ticket.users[0]" /><br ng-if="ticket.users[0]" />-->

            <!-- Ticket's description, creator's name -->
            <textarea ng-readonly="true"
                      rows="5"
                      ng-model="ticket.description"></textarea>
            <p>
                By {{ticket.creator.firstname}} {{ticket.creator.lastname}}<br />
                Created: {{ticket.createdAt}}<br />
                <span ng-show="ticket.editedAt">Edited: {{ticket.editedAt}}</span>
            </p>
            <!-- <a ng-show="ticket.creator.id == userConnectedId"
               class="button button-block button-positive icon ion-edit"
               ui-sref="app.editTicket({projectId: projectId, ticketId: ticketId})">
            </a> -->
        </div>

        <!-- Comments on ticket-->
        <div class="item item-divider">Comments</div>
        <ion-item ng-repeat="com in comments">
            <textarea rows="5"
                      ng-readonly="com.creator.id != userConnectedId"
                      ng-model="com.comment"></textarea>
            <p>By {{com.creator.firstname}} {{com.creator.lastname}}</p>
            <div class="button-bar" ng-show="com.creator.id == userConnectedId">
                <a class="button button-clear icon ion-ios-trash button-assertive"
                   ng-click="CloseComment(com)">
                </a>
                <a class="button button-clear icon ion-edit gb-color-bugtracker"
                   ng-click="EditCommentOnTicket(com)">
                </a>
            </div>
        </ion-item>

        <!-- No comment error -->
        <p ng-show="comments[0] == null">There is no comment.</p>
        <div class="item item-divider">Comment on issue</div>

        <!-- Commenting form -->
        <form name="comment_form">
            <!-- Comment's description -->
            <ion-item>
                <textarea name="comment_description"
                          rows="5"
                          placeholder="Leave a comment"
                          ng-model="comment.description" required></textarea>
            </ion-item>
            <div class="button-bar">
                <!-- If ticket is open & Comment is empty -->
                <a ng-show="ticket.deletedAt == null && comment.description == null"
                   class="button button-clear button-assertive"
                   ng-click="CloseTicket()">
                    CLOSE
                </a>
                <!-- If ticket is open & Comment isn't empty -->
                <a ng-show="ticket.deletedAt == null && comment.description != null"
                   class="button button-clear button-assertive"
                   ng-click="CloseTicketAndComment()">
                    CLOSE & COMMENT
                </a>
                <!-- If ticket is closed & Comment is empty -->
                <a ng-show="ticket.deletedAt != null && comment.description == null"
                   class="button button-clear button-assertive"
                   ng-click="ReopenTicket()">
                    REOPEN
                </a>
                <!-- If ticket is closed & Comment isn't empty -->
                <a ng-show="ticket.deletedAt != null && comment.description != null"
                   class="button button-clear button-assertive"
                   ng-click="ReopenTicketAndComment()">
                    REOPEN & COMMENT
                </a>
                <!-- Comment button -->
                <a class="button button-clear gb-color-bugtracker"
                   ng-disabled="comment_form.$invalid"
                   ng-click="PostComment()">
                    COMMENT
                </a>
            </div>
        </form>
    </ion-content>
</ion-view>
